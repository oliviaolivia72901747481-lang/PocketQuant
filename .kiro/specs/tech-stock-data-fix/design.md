# 科技股数据获取问题修复设计

## 概述

本设计旨在解决科技股专属板块回测验证时无法获取股票数据的问题。通过增强数据完整性检查、自动下载功能和用户友好的错误提示，确保科技股回测功能的正常运行。

## 架构设计

### 核心组件

1. **TechDataValidator**：科技股数据验证器
2. **TechDataDownloader**：科技股数据下载器  
3. **DataStatusChecker**：数据状态检查器
4. **UI增强组件**：用户界面改进

### 数据流

```
用户点击回测 → 数据完整性检查 → 发现缺失数据 → 提示用户下载 → 自动下载 → 验证完成 → 开始回测
```

## 详细设计

### 1. TechDataValidator（科技股数据验证器）

```python
class TechDataValidator:
    """科技股数据验证器"""
    
    def validate_tech_stock_data(self, stock_codes: List[str]) -> ValidationResult:
        """验证科技股数据完整性"""
        
    def check_data_time_range(self, code: str, start_date: str, end_date: str) -> bool:
        """检查数据时间范围是否足够"""
        
    def get_missing_data_report(self, stock_codes: List[str]) -> Dict[str, str]:
        """生成缺失数据报告"""
```

### 2. TechDataDownloader（科技股数据下载器）

```python
class TechDataDownloader:
    """科技股数据下载器"""
    
    def download_tech_stock_pool(self, progress_callback=None) -> DownloadResult:
        """下载整个科技股池的数据"""
        
    def download_missing_stocks(self, missing_codes: List[str]) -> DownloadResult:
        """下载缺失的股票数据"""
        
    def get_download_progress(self) -> Dict[str, Any]:
        """获取下载进度"""
```

### 3. UI组件增强

#### 3.1 科技股页面增强

在 `app/pages/8_🔬_Tech_Stock.py` 中添加：

- 数据状态检查面板
- 自动下载按钮
- 数据完整性警告

#### 3.2 数据管理页面增强

在 `app/pages/1_📊_Data_Manager.py` 中添加：

- 科技股数据专区
- 批量下载功能
- 数据状态概览

### 4. 错误处理和用户提示

#### 4.1 错误信息设计

```python
ERROR_MESSAGES = {
    "missing_data": "以下科技股缺少历史数据：{missing_stocks}",
    "insufficient_data": "股票 {code} 的数据时间范围不足，需要 {required_range}",
    "download_failed": "下载 {code} 数据失败：{error_reason}",
    "solution_hint": "建议：点击'下载科技股数据'按钮自动获取所需数据"
}
```

#### 4.2 用户友好提示

- 使用 Streamlit 的 `st.error()` 显示错误
- 使用 `st.warning()` 显示警告
- 使用 `st.info()` 提供解决方案
- 使用进度条显示下载进度

## 实现方案

### 阶段1：数据验证增强

1. 修改 `TechBacktester.run_backtest()` 方法
2. 在回测开始前添加数据完整性检查
3. 提供清晰的错误信息和解决方案

### 阶段2：自动下载功能

1. 创建 `TechDataDownloader` 类
2. 在科技股页面添加下载按钮
3. 实现批量下载和进度显示

### 阶段3：UI界面优化

1. 在科技股页面添加数据状态面板
2. 在数据管理页面添加科技股专区
3. 优化错误提示和用户体验

### 阶段4：数据同步检查

1. 系统启动时检查数据同步状态
2. 定期验证科技股池与数据文件的一致性
3. 提供数据状态概览

## 正确性属性

### 属性1：数据完整性验证
*对于任何*科技股代码列表，数据验证器应该能够准确识别缺失的数据文件
**验证：需求1.1, 1.2**

### 属性2：下载结果一致性  
*对于任何*成功下载的股票，其数据文件应该存在于processed目录中且格式正确
**验证：需求2.2, 2.3**

### 属性3：错误信息准确性
*对于任何*数据获取错误，系统应该提供准确的错误描述和可行的解决方案
**验证：需求1.2, 1.3**

### 属性4：回测前验证完整性
*对于任何*回测请求，在开始回测前应该验证所有必需数据的可用性
**验证：需求4.1, 4.2**

## 错误处理策略

### 1. 数据文件不存在
- 检测：文件系统检查
- 处理：提示用户下载，提供自动下载选项
- 恢复：下载完成后重新验证

### 2. 数据时间范围不足
- 检测：比较数据日期范围与回测需求
- 处理：警告用户并建议更新数据
- 恢复：重新下载最新数据

### 3. 网络下载失败
- 检测：捕获网络异常
- 处理：显示具体错误原因，提供重试选项
- 恢复：用户手动重试或稍后再试

### 4. 数据格式错误
- 检测：数据加载时验证格式
- 处理：提示数据损坏，建议重新下载
- 恢复：删除损坏文件，重新下载

## 测试策略

### 单元测试
- 测试数据验证逻辑
- 测试下载功能
- 测试错误处理

### 集成测试
- 测试完整的数据获取流程
- 测试UI交互
- 测试错误恢复机制

### 用户验收测试
- 验证用户体验改进
- 验证错误信息的清晰度
- 验证自动下载功能的可用性

## 性能考虑

1. **批量下载优化**：使用多线程并发下载，但限制并发数避免被限流
2. **进度显示**：实时更新下载进度，避免用户等待焦虑
3. **缓存机制**：避免重复检查已验证的数据
4. **异步处理**：下载过程不阻塞UI界面

## 兼容性

1. **向后兼容**：不影响现有的数据管理功能
2. **配置兼容**：与现有的科技股池配置保持一致
3. **接口兼容**：不改变现有的DataFeed接口